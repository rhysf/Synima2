#!/usr/bin/env python3.11
import os
import sys

HERE = os.path.dirname(os.path.abspath(__file__))           # .../bin/Darwin.arm64
platform_dir = os.path.basename(HERE)                       # "Darwin.arm64"
root = os.path.normpath(os.path.join(HERE, "..", ".."))     # Synima2 root
runtime_root = os.path.join(root, "orthofinder_runtime", platform_dir)

# 1. Put this bin dir first in PATH so bundled mafft, fasttree, etc are found
old_path = os.environ.get("PATH", "")
os.environ["PATH"] = HERE + (os.pathsep + old_path if old_path else "")

# 2. Locate site-packages
lib_base = os.path.join(runtime_root, "lib")

if not os.path.isdir(lib_base):
    sys.stderr.write(f"orthofinder wrapper: missing lib/ under {runtime_root}\n")
    sys.exit(1)

site_packages = None
for name in os.listdir(lib_base):
    if name.startswith("python3."):
        candidate = os.path.join(lib_base, name, "site-packages")
        if os.path.isdir(candidate):
            site_packages = candidate
            break

if site_packages is None:
    sys.stderr.write(
        f"orthofinder wrapper: could not find python3.X/site-packages under {lib_base}\n"
    )
    sys.exit(1)

# Optional: enforce the Python version to match the runtime you built (3.11 here)
required = "3.11"
current = f"{sys.version_info[0]}.{sys.version_info[1]}"
if current != required:
    sys.stderr.write(
        f"orthofinder wrapper: requires Python {required}, got {current}\n"
    )
    sys.exit(1)

# Put site-packages first on sys.path so scripts_of and deps are found
sys.path.insert(0, site_packages)

if __name__ == "__main__":
    from scripts_of.__main__ import main
    sys.exit(main())
